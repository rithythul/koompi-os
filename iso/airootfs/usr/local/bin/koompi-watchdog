#!/usr/bin/env bash
# KOOMPI Boot Watchdog
# Monitors boot success and triggers auto-rollback on repeated failures
# Part of KOOMPI OS immutability system

set -euo pipefail

COUNTER_FILE="/var/lib/koompi/boot-counter"
COUNTER_DIR="/var/lib/koompi"
MAX_FAILURES=3

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[WATCHDOG]${NC} $1"
    logger -t koompi-watchdog "$1"
}

warn() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
    logger -p user.warning -t koompi-watchdog "$1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    logger -p user.err -t koompi-watchdog "$1"
}

# Initialize counter directory
init_counter() {
    mkdir -p "$COUNTER_DIR"
    if [[ ! -f "$COUNTER_FILE" ]]; then
        echo "0" > "$COUNTER_FILE"
    fi
}

# Get current boot counter
get_counter() {
    init_counter
    cat "$COUNTER_FILE" 2>/dev/null || echo "0"
}

# Increment boot counter
increment_counter() {
    init_counter
    local current=$(get_counter)
    local new_count=$((current + 1))
    echo "$new_count" > "$COUNTER_FILE"
    log "Boot counter incremented: $new_count"
    echo "$new_count"
}

# Reset boot counter
reset_counter() {
    init_counter
    echo "0" > "$COUNTER_FILE"
    log "Boot counter reset to 0"
}

# Check if auto-rollback should trigger
check_rollback() {
    local count=$(get_counter)
    
    if [[ $count -ge $MAX_FAILURES ]]; then
        return 0  # True - should rollback
    else
        return 1  # False - no rollback needed
    fi
}

# Perform automatic rollback
perform_rollback() {
    error "Boot failure detected ($MAX_FAILURES consecutive failures)"
    warn "Initiating automatic rollback to last known good snapshot"
    
    # Find the most recent successful snapshot
    local last_good=$(find /.snapshots -maxdepth 1 -type d -name "2*" | sort -r | head -n 2 | tail -n 1 | xargs basename)
    
    if [[ -z "$last_good" ]]; then
        error "No previous snapshot found for rollback!"
        warn "System may be in an unrecoverable state."
        warn "Manual intervention required."
        return 1
    fi
    
    log "Rolling back to snapshot: $last_good"
    
    # Use koompi-snapshot to rollback
    if /usr/local/bin/koompi-snapshot rollback "$last_good" --auto; then
        log "Rollback configured successfully"
        warn "System will reboot in 10 seconds..."
        sleep 10
        systemctl reboot
    else
        error "Rollback failed!"
        return 1
    fi
}

# Handle boot check (called early in boot)
cmd_check() {
    log "Checking boot status..."
    
    # Increment boot counter
    local count=$(increment_counter)
    
    # Check if rollback is needed
    if check_rollback; then
        warn "Boot failure threshold reached ($count/$MAX_FAILURES)"
        perform_rollback
    else
        log "Boot attempt $count/$MAX_FAILURES - continuing normally"
    fi
}

# Handle boot success (called after successful boot)
cmd_success() {
    log "System boot successful - resetting failure counter"
    reset_counter
}

# Show current status
cmd_status() {
    local count=$(get_counter)
    echo "Boot failure counter: $count/$MAX_FAILURES"
    
    if check_rollback; then
        echo "Status: CRITICAL - Auto-rollback will trigger on next boot"
        return 1
    elif [[ $count -gt 0 ]]; then
        echo "Status: WARNING - $((MAX_FAILURES - count)) failures remaining before rollback"
        return 0
    else
        echo "Status: OK"
        return 0
    fi
}

# Show usage
usage() {
    cat <<EOF
KOOMPI Boot Watchdog

Usage: koompi-watchdog <command>

Commands:
  check        Check boot status and increment counter (run early in boot)
  success      Mark boot as successful and reset counter (run after boot completes)
  status       Show current watchdog status
  reset        Manually reset boot counter

This tool is automatically called by systemd during boot process.
Manual usage is typically not required.

EOF
}

# Main command handler
main() {
    local command="${1:-}"
    
    case "$command" in
        check)
            cmd_check
            ;;
        success)
            cmd_success
            ;;
        status)
            cmd_status
            ;;
        reset)
            reset_counter
            ;;
        help|--help|-h)
            usage
            ;;
        *)
            usage
            exit 1
            ;;
    esac
}

main "$@"
