#!/usr/bin/env bash
# KOOMPI Security Hardening Tool
# Optional security features for education/enterprise environments

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Security packages (installed on-demand)
SECURITY_PKGS=(
    ufw           # Firewall
    apparmor      # Mandatory Access Control
    fail2ban      # Brute force protection
    audit         # System auditing
    firejail      # Application sandboxing
    sbctl         # Secure Boot management
)

log() { echo -e "${GREEN}[SECURITY]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
info() { echo -e "${CYAN}[INFO]${NC} $1"; }

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "This command requires root privileges. Use: sudo koompi-security $*"
    fi
}

# Show security status
show_status() {
    echo -e "\n${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  KOOMPI OS Security Status${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}\n"

    # Firewall (UFW)
    if command -v ufw &>/dev/null; then
        local ufw_status=$(ufw status 2>/dev/null | head -1)
        if [[ "$ufw_status" == *"active"* ]]; then
            echo -e "  Firewall (UFW):        ${GREEN}● Active${NC}"
        else
            echo -e "  Firewall (UFW):        ${YELLOW}○ Inactive${NC}"
        fi
    else
        echo -e "  Firewall (UFW):        ${RED}✗ Not installed${NC}"
    fi

    # AppArmor
    if command -v aa-status &>/dev/null; then
        if systemctl is-active apparmor.service &>/dev/null; then
            local profiles=$(aa-status 2>/dev/null | grep "profiles are loaded" | awk '{print $1}')
            echo -e "  AppArmor:              ${GREEN}● Active${NC} ($profiles profiles)"
        else
            echo -e "  AppArmor:              ${YELLOW}○ Inactive${NC}"
        fi
    else
        echo -e "  AppArmor:              ${RED}✗ Not installed${NC}"
    fi

    # Fail2ban
    if command -v fail2ban-client &>/dev/null; then
        if systemctl is-active fail2ban.service &>/dev/null; then
            echo -e "  Fail2ban:              ${GREEN}● Active${NC}"
        else
            echo -e "  Fail2ban:              ${YELLOW}○ Inactive${NC}"
        fi
    else
        echo -e "  Fail2ban:              ${RED}✗ Not installed${NC}"
    fi

    # Audit
    if command -v auditctl &>/dev/null; then
        if systemctl is-active auditd.service &>/dev/null; then
            echo -e "  Audit daemon:          ${GREEN}● Active${NC}"
        else
            echo -e "  Audit daemon:          ${YELLOW}○ Inactive${NC}"
        fi
    else
        echo -e "  Audit daemon:          ${RED}✗ Not installed${NC}"
    fi

    # Firejail
    if command -v firejail &>/dev/null; then
        echo -e "  Firejail:              ${GREEN}● Installed${NC}"
    else
        echo -e "  Firejail:              ${RED}✗ Not installed${NC}"
    fi

    # Secure Boot
    if command -v sbctl &>/dev/null; then
        if sbctl status 2>/dev/null | grep -q "Secure Boot.*Enabled"; then
            echo -e "  Secure Boot (sbctl):   ${GREEN}● Enabled${NC}"
        else
            echo -e "  Secure Boot (sbctl):   ${YELLOW}○ Available (not enrolled)${NC}"
        fi
    else
        echo -e "  Secure Boot (sbctl):   ${RED}✗ Not installed${NC}"
    fi

    # SSH status (relevant for fail2ban)
    if systemctl is-active sshd.service &>/dev/null; then
        echo -e "\n  SSH Server:            ${YELLOW}● Running${NC} (fail2ban recommended)"
    else
        echo -e "\n  SSH Server:            ${GREEN}○ Not running${NC}"
    fi

    echo ""
}

# Install security packages
install_packages() {
    log "Installing security packages..."

    # Check if packages are already installed
    local to_install=()
    for pkg in "${SECURITY_PKGS[@]}"; do
        if ! pacman -Qi "$pkg" &>/dev/null; then
            to_install+=("$pkg")
        fi
    done

    if [[ ${#to_install[@]} -eq 0 ]]; then
        log "All security packages already installed."
        return 0
    fi

    log "Installing: ${to_install[*]}"
    pacman -S --noconfirm "${to_install[@]}"
}

# Configure firewall
configure_firewall() {
    if ! command -v ufw &>/dev/null; then
        warn "UFW not installed, skipping firewall configuration."
        return
    fi

    log "Configuring firewall (UFW)..."

    # Set defaults
    ufw default deny incoming
    ufw default allow outgoing

    # Allow SSH if sshd is enabled
    if systemctl is-enabled sshd.service &>/dev/null; then
        ufw allow ssh
        log "SSH access allowed through firewall."
    fi

    # Enable UFW
    ufw --force enable
    systemctl enable ufw.service

    log "Firewall configured and enabled."
}

# Configure AppArmor
configure_apparmor() {
    if ! command -v apparmor_parser &>/dev/null; then
        warn "AppArmor not installed, skipping."
        return
    fi

    log "Configuring AppArmor..."

    # Enable service
    systemctl enable apparmor.service
    systemctl start apparmor.service

    # Check if kernel parameter is set
    if ! grep -q "apparmor=1" /proc/cmdline; then
        warn "AppArmor kernel parameters not set."
        warn "Add to GRUB: apparmor=1 security=apparmor"

        # Update GRUB config if possible
        if [[ -f /etc/default/grub ]]; then
            if ! grep -q "apparmor=1" /etc/default/grub; then
                log "Updating GRUB configuration..."
                sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="\([^"]*\)"/GRUB_CMDLINE_LINUX_DEFAULT="\1 apparmor=1 security=apparmor"/' /etc/default/grub

                if command -v grub-mkconfig &>/dev/null; then
                    grub-mkconfig -o /boot/grub/grub.cfg
                    log "GRUB updated. Reboot required for AppArmor kernel support."
                fi
            fi
        fi
    fi

    log "AppArmor configured."
}

# Configure fail2ban
configure_fail2ban() {
    if ! command -v fail2ban-client &>/dev/null; then
        warn "Fail2ban not installed, skipping."
        return
    fi

    log "Configuring Fail2ban..."

    # Create local config
    mkdir -p /etc/fail2ban
    cat > /etc/fail2ban/jail.local << 'EOF'
[DEFAULT]
bantime = 1h
findtime = 10m
maxretry = 5

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
EOF

    systemctl enable fail2ban.service
    systemctl start fail2ban.service

    log "Fail2ban configured."
}

# Configure audit daemon
configure_audit() {
    if ! command -v auditctl &>/dev/null; then
        warn "Audit not installed, skipping."
        return
    fi

    log "Configuring audit daemon..."

    systemctl enable auditd.service
    systemctl start auditd.service

    log "Audit daemon configured."
}

# Full hardening
harden() {
    check_root

    echo -e "\n${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  KOOMPI OS Security Hardening${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}\n"

    log "Starting security hardening..."

    # Install packages
    install_packages

    # Configure each component
    configure_firewall
    configure_apparmor
    configure_fail2ban
    configure_audit

    echo ""
    log "Security hardening complete!"
    warn "A reboot is recommended for all changes to take effect."
    echo ""

    # Show final status
    show_status
}

# Disable security features
disable_security() {
    check_root

    log "Disabling security services..."

    # Disable UFW
    if command -v ufw &>/dev/null; then
        ufw disable 2>/dev/null || true
        systemctl disable ufw.service 2>/dev/null || true
    fi

    # Disable AppArmor
    systemctl disable apparmor.service 2>/dev/null || true
    systemctl stop apparmor.service 2>/dev/null || true

    # Disable fail2ban
    systemctl disable fail2ban.service 2>/dev/null || true
    systemctl stop fail2ban.service 2>/dev/null || true

    # Disable audit
    systemctl disable auditd.service 2>/dev/null || true
    systemctl stop auditd.service 2>/dev/null || true

    log "Security services disabled."
    warn "Note: Security packages remain installed."
}

# Show help
show_help() {
    cat << 'EOF'

  ██╗  ██╗ ██████╗  ██████╗ ███╗   ███╗██████╗ ██╗
  ██║ ██╔╝██╔═══██╗██╔═══██╗████╗ ████║██╔══██╗██║
  █████╔╝ ██║   ██║██║   ██║██╔████╔██║██████╔╝██║
  ██╔═██╗ ██║   ██║██║   ██║██║╚██╔╝██║██╔═══╝ ██║
  ██║  ██╗╚██████╔╝╚██████╔╝██║ ╚═╝ ██║██║     ██║
  ╚═╝  ╚═╝ ╚═════╝  ╚═════╝ ╚═╝     ╚═╝╚═╝     ╚═╝
                              Security Hardening Tool

USAGE:
    koompi-security <command>

COMMANDS:
    status      Show current security status
    harden      Install and enable all security features
    disable     Disable security services (keeps packages)
    help        Show this help message

SECURITY FEATURES:
    • UFW         - Uncomplicated Firewall (deny incoming by default)
    • AppArmor    - Mandatory Access Control (restrict program capabilities)
    • Fail2ban    - Brute force protection (auto-ban failed logins)
    • Audit       - System auditing (security event logging)
    • Firejail    - Application sandboxing (isolate untrusted apps)
    • sbctl       - Secure Boot key management

EXAMPLES:
    sudo koompi-security status     # Check current security status
    sudo koompi-security harden     # Enable full security hardening
    sudo koompi-security disable    # Disable security services

    # Sandbox an application with firejail:
    firejail firefox
    firejail --private chromium

EOF
}

# Main
case "${1:-help}" in
    status)
        show_status
        ;;
    harden)
        harden
        ;;
    disable)
        disable_security
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        error "Unknown command: $1. Use 'koompi-security help' for usage."
        ;;
esac
